---
title: "Sesión 2"
subtitle: <h4 style="font-style:normal">La creación de un flujo de trabajo</h4>
date: <h4 style="font-style:normal">21 de noviembre de 2020</h4>
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: cosmo
---


<style>
p.comment {
background-color: #DBDBDB;
padding: 10px;
border: 1px solid black;
margin-left: 25px;
border-radius: 5px;
font-style: italic;
}

.figure {
   margin-top: 20px;
   margin-bottom: 20px;
}

h1.title {
  font-weight: bold;
  font-family: Arial;  
}

h2.title {
  font-family: Arial;  
}

</style>


<style type="text/css">
#TOC {
  font-size: 13px;
  font-family: Arial;
}
</style>

\




## Objetivo

El objetivo de esta sesión es el de entender los 5 procesos fundamentales del *tidyverse*.

1. `select()`
2. `arrange()`
3. `filter()`
4. `mutate()`
5. `group_by() + summarise()`

Para ese fin, haremos una limpieza de datos (*wrangling*) y los trataremos para respondernos una pregunta candente: ¿cómo ha gastado el gobierno federal el dinero destinado a comunicación social?

## Estrategia

Como siempre usaremos una estrategia muy ordenada. Como dijimos la sesión pasada, el orden a niveles obsesivos es siempre una gran inversión de tiempos.

### 0. Setup


```r
rm(list = ls())
```

### 1. Bibliotecas


```r
library(tidyverse)
library(readxl) #Ya instalado con el tidyverse
library(janitor) #Joya
```

```
## 
## Attaching package: 'janitor'
```

```
## The following objects are masked from 'package:stats':
## 
##     chisq.test, fisher.test
```

### 2. Datos

### 2.1 Descarga

Descargaremos el archivo directamente desde el código.


```r
url <- "http://funcionpublica.gob.mx/web/transparencia/transparencia-focalizada/2020/Base_de_datos_Polizas_12_Diciembre-2019_Definitivo_Transp.xlsx"

destfile <- "datos/comsoc.xlsx"

download.file(url, destfile, mode = "wb")
```

#### 2.2 Importar

El resultado de la importación es una cosa horrible.

Aquí podrías utilizar el modo *manual* también.


```r
comsoc.19 <- read_excel("datos/comsoc.xlsx")
```

```
## New names:
## * `` -> ...1
## * `` -> ...2
## * `` -> ...3
## * `` -> ...5
## * `` -> ...6
## * ...
```

```r
comsoc.19
```

```
## # A tibble: 12,340 x 27
##    ...1  ...2  ...3  `SECRETARÍA DE ~ ...5  ...6  ...7  ...8  ...9  ...10 ...11 ...12 ...13 ...14 ...15 ...16 ...17 ...18
##    <chr> <chr> <chr> <chr>            <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr> <chr>
##  1 <NA>  <NA>   <NA> Todos los monto~ <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA> 
##  2 <NA>  <NA>   <NA> PERÍODO: ENERO ~ <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA> 
##  3 <NA>  CS066 "Con~ <NA>             <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA> 
##  4 <NA>  <NA>  "Fec~ <NA>             <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA>  <NA> 
##  5 Sect~ Tipo~ "Ent~ Nombre           Mes   Fech~ Part~ Póli~ Cons. No. ~ Fech~ Prod~ Desc~ Impo~ IVA   Pers~ Clas~ Bene~
##  6 0     E     "625" INSTITUTO NACIO~ 12    43830 36101 14331 1     DAOP~ 43691 37    INTE~ 5807~ 9291~ M     P     LA J~
##  7 0     E     "625" INSTITUTO NACIO~ 12    43830 36101 14331 1     DAOP~ 43691 37    INTE~ <NA>  <NA>  M     P     LA J~
##  8 0     E     "625" INSTITUTO NACIO~ 12    43830 36101 14331 0     DAOP~ 43691 21    DIAR~ 1018~ 16296 M     P     LA J~
##  9 0     E     "625" INSTITUTO NACIO~ 12    43830 36101 14331 0     DAOP~ 43691 21    DIAR~ <NA>  <NA>  M     P     LA J~
## 10 0     E     "625" INSTITUTO NACIO~ 12    43830 36101 14410 10    DAOP~ 43691 22    DIAR~ 1197~ 1916~ M     P     MEDI~
## # ... with 12,330 more rows, and 9 more variables: ...19 <chr>, ...20 <chr>, ...21 <chr>, ...22 <chr>, ...23 <chr>,
## #   ...24 <chr>, ...25 <chr>, ...26 <chr>, ...27 <chr>
```

¿Qué observas?, ¿qué está mal?, ¿cómo podríamos solucionarlo?

#### 2.3 Wrangling

De entrada, *MS Excel* se acomoda por hojas de cálculo en libros. Entonces, lo primero es observar cómo podemos quedarnos solamente con la información relevante. Vamos por pasos.

De entrada, R lee la primera hoja, pero no es la única que comprende este archivo.


```r
excel_sheets(path = "datos/comsoc.xlsx") # Nombres de las hojas
```

```
## [1] "Pólizas C-3600 Dic-2019 Defini"  "Pólizas P-33605 Dic-2019 Defini"
```


Segundo, con `skip` podemos brincarnos los renglones que nos estorban en el título y que ponen el logo de la dependencia.


```r
comsoc.19a <- read_excel("datos/comsoc.xlsx", 
                        skip=5,
                        sheet = "Pólizas C-3600 Dic-2019 Defini")

comsoc.19b <- read_excel("datos/comsoc.xlsx", 
                        skip=5,
                        sheet = "Pólizas P-33605 Dic-2019 Defini")

comsoc.19 <- bind_rows(comsoc.19a, comsoc.19b)
```

Tercero, y como el tiempo apremia, podemos filtrar aquellas observaciones que tienen espacio vacío en *Costo*. Esta estrategia es útil, pero falta un paso. Como el excel


```r
comsoc.19.limpio <- comsoc.19 %>% 
  filter(!is.na(Costo)) %>% 
  filter(Sector != "Sector") 

comsoc.19.limpio
```

```
## # A tibble: 7,625 x 27
##    Sector `Tipo Instituci~ Entidad Nombre Mes   `Fecha de gasto` Partida Póliza Cons. `No. de Contrat~ `Fecha de Contr~
##    <chr>  <chr>            <chr>   <chr>  <chr> <chr>            <chr>   <chr>  <chr> <chr>            <chr>           
##  1 0      E                625     INSTI~ 12    43830            36101   14331  1     DAOP-031-22-2019 43691           
##  2 0      E                625     INSTI~ 12    43830            36101   14331  0     DAOP-031-22-2019 43691           
##  3 0      E                625     INSTI~ 12    43830            36101   14410  10    DAOP-031-36-2019 43691           
##  4 0      E                625     INSTI~ 12    43830            36101   14410  0     DAOP-031-26-2019 43691           
##  5 0      E                625     INSTI~ 12    43830            36101   14410  1     DAOP-031-26-200~ 43691           
##  6 0      E                625     INSTI~ 12    43830            36101   14410  2     DAOP-031-26-2019 43691           
##  7 0      E                625     INSTI~ 12    43830            36101   14410  3     DAOP-031-26-2019 43691           
##  8 0      E                625     INSTI~ 12    43830            36101   14410  4     DAOP-031-26-2019 43691           
##  9 0      E                625     INSTI~ 12    43830            36101   14410  5     SAOP-031-26-2019 43691           
## 10 0      E                625     INSTI~ 12    43830            36101   14410  6     DAOP-031-26-2019 43691           
## # ... with 7,615 more rows, and 16 more variables: Producto <chr>, `Descripción Producto` <chr>, Importe <chr>,
## #   IVA <chr>, `Persona (F/M)` <chr>, `Clase de Beneficiario` <chr>, Beneficiario <chr>, Campaña <chr>,
## #   Intercambio <chr>, `Unidad de medida` <chr>, `Descripción Unidad` <chr>, Cantidad <chr>, `Costo Unitario` <chr>,
## #   Costo <chr>, `IVA del Costo` <chr>, `Notas aclaratorias` <chr>
```



```r
glimpse(comsoc.19.limpio)
```

```
## Rows: 7,625
## Columns: 27
## $ Sector                     <chr> "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "...
## $ `Tipo Institución`         <chr> "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "E", "...
## $ Entidad                    <chr> "625", "625", "625", "625", "625", "625", "625", "625", "625", "625", "625", "625...
## $ Nombre                     <chr> "INSTITUTO NACIONAL DE LOS PUEBLOS INDÍGENAS (INPI)", "INSTITUTO NACIONAL DE LOS ...
## $ Mes                        <chr> "12", "12", "12", "12", "12", "12", "12", "12", "12", "12", "12", "12", "12", "12...
## $ `Fecha de gasto`           <chr> "43830", "43830", "43830", "43830", "43830", "43830", "43830", "43830", "43830", ...
## $ Partida                    <chr> "36101", "36101", "36101", "36101", "36101", "36101", "36101", "36101", "36101", ...
## $ Póliza                     <chr> "14331", "14331", "14410", "14410", "14410", "14410", "14410", "14410", "14410", ...
## $ Cons.                      <chr> "1", "0", "10", "0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "11", "12", "13...
## $ `No. de Contrato/Pedido`   <chr> "DAOP-031-22-2019", "DAOP-031-22-2019", "DAOP-031-36-2019", "DAOP-031-26-2019", "...
## $ `Fecha de Contrato/Pedido` <chr> "43691", "43691", "43691", "43691", "43691", "43691", "43691", "43691", "43691", ...
## $ Producto                   <chr> "37", "21", "22", "22", "22", "22", "22", "22", "22", "22", "22", "22", "22", "22...
## $ `Descripción Producto`     <chr> "INTERNET", "DIARIOS EDITADOS EN LA CD. DE MÉXICO", "DIARIOS EDITADOS EN LOS ESTA...
## $ Importe                    <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ IVA                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ `Persona (F/M)`            <chr> "M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "M", "...
## $ `Clase de Beneficiario`    <chr> "P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "P", "...
## $ Beneficiario               <chr> "LA JORNADA, DEMOS DESARROLLO DE MED IOS, S.A. DE C.V.", "LA JORNADA, DEMOS DESAR...
## $ Campaña                    <chr> "051/19-2001-TC22-00625", "051/19-2001-TC22-00625", "051/19-2001-TC22-00625", "05...
## $ Intercambio                <chr> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N...
## $ `Unidad de medida`         <chr> "99", "28", "28", "28", "28", "28", "28", "28", "28", "28", "28", "28", "28", "28...
## $ `Descripción Unidad`       <chr> "OTRO FORMATO (ESPECIFICAR EN NOTAS ACLARATORIAS)", "1/4 PLANA", "1/4 PLANA", "1/...
## $ Cantidad                   <chr> "1", "2", "20", "6", "20", "9", "18", "9", "9", "7", "10", "8", "9", "11", "11", ...
## $ `Costo Unitario`           <chr> "58070.720000000001", "50925", "5988.83", "19129.34", "6148.88", "22801.21", "725...
## $ Costo                      <chr> "58070.720000000001", "101850", "119776.6", "114776.04", "122977.60000000001", "2...
## $ `IVA del Costo`            <chr> "9291.32", "16296", "19164.259999999998", "18364.169999999998", "19676.4199999999...
## $ `Notas aclaratorias`       <chr> "BOX BANNER", NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, "BOX BANNER...
```


```r
comsoc.19.limpio %>% 
  mutate(Costo = as.numeric(Costo)) %>% 
  arrange(-Costo)
```

```
## # A tibble: 7,625 x 27
##    Sector `Tipo Instituci~ Entidad Nombre Mes   `Fecha de gasto` Partida Póliza Cons. `No. de Contrat~ `Fecha de Contr~
##    <chr>  <chr>            <chr>   <chr>  <chr> <chr>            <chr>   <chr>  <chr> <chr>            <chr>           
##  1 0      E                641     INSTI~ 12    43775            36101   PO037~ 3     UCSA190922020010 43698           
##  2 4      D                4000    SECRE~ 12    43861            36101   30024~ 0     <NA>             <NA>            
##  3 4      D                4000    SECRE~ 12    43861            36101   30024~ 0     <NA>             <NA>            
##  4 0      E                641     INSTI~ 12    43817            36101   PO038~ 1     UCSA190922020009 43698           
##  5 4      D                4000    SECRE~ 12    43878            36101   30026~ 0     <NA>             <NA>            
##  6 0      E                641     INSTI~ 12    43811            36101   PO038~ 12    UCSA190922020009 43698           
##  7 4      D                4000    SECRE~ 12    43881            36101   30026~ 0     <NA>             <NA>            
##  8 0      E                641     INSTI~ 11    43734            36101   PO037~ 2     UCSA190922020010 43698           
##  9 0      E                641     INSTI~ 12    43810            36101   PO038~ 0     UCSA190922020010 43698           
## 10 4      D                4000    SECRE~ 12    43878            36101   30026~ 0     <NA>             <NA>            
## # ... with 7,615 more rows, and 16 more variables: Producto <chr>, `Descripción Producto` <chr>, Importe <chr>,
## #   IVA <chr>, `Persona (F/M)` <chr>, `Clase de Beneficiario` <chr>, Beneficiario <chr>, Campaña <chr>,
## #   Intercambio <chr>, `Unidad de medida` <chr>, `Descripción Unidad` <chr>, Cantidad <chr>, `Costo Unitario` <chr>,
## #   Costo <dbl>, `IVA del Costo` <chr>, `Notas aclaratorias` <chr>
```

